<div [hidden]="showAttachments">
  <div class="slds-page-header" style="padding: 0.3rem;">
    <button (click)="openAttachments()" class="slds-button slds-button_icon slds-button_icon-border slds-float_right slds-m-around_x-small" title="Attach">
      <svg class="slds-button__icon_large" aria-hidden="true">
        <use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#attach"></use>
      </svg>
      <span class="slds-assistive-text">Attach</span>
    </button>

    <div class="slds-page-header__row">
      <div class="slds-page-header__col-title">
        <div class="slds-media" style="align-items: center">
          <div *ngIf="session.recipientPhotoUrl" class="slds-media__figure">
            <span class="slds-icon_container">
              <img src="{{session.recipientPhotoUrl}}" alt="Profile picture" class="image-round">
            </span>
          </div>
          <div [hidden]="session.recipientPhotoUrl" [style]="dynamicColourAvatarStyle" class="slds-media__figure slds-p-around_medium">
            {{recipientAbbrev}}
          </div>
          <div class="slds-media__body slds-m-top_xx-small">
            <div class="slds-text-heading_small truncate">
              <span>{{session.recipientName}}</span>
            </div>
            <div *ngIf="session.psychologistReturnDate" class="slds-text-color_error">Unavailable until {{helpersService.convertToLocalDate(session.psychologistReturnDate) | date}}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading" class="slds-form-element slds-m-top_medium">
    <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_right">
      <textarea #messageInput [maxlength]="maxMessageChars" rows="2" (onpaste)="autoGrowMessageInput()" (keyup)="autoGrowMessageInput()" placeholder="Type your message here..." [(ngModel)]="messageText" style="line-height:1.2; height:60px" class="slds-input slds-p-around_xx-small"></textarea>
      <div style="height: 30px;">

        <span class="meta-text">{{messageCharsLeft}} characters left</span>

        <button *ngIf="messageText.length > 0" (click)="createMessage()" class="slds-button slds-button_outline-brand slds-float_right" title="Send">
          Send
        </button>
      </div>
    </div>
  </div>

  <section role="log" class="slds-chat">

    <ul class="slds-chat-list">

      <li *ngIf="!loading && sessionMessages.length == 0" class="slds-chat-listitem">
        <div class="slds-chat-bookend" style="border:0px">
          <span class="slds-icon_container slds-icon-utility-chat slds-chat-icon">
            <svg class="slds-icon slds-icon_x-small slds-icon-text-default" aria-hidden="true">
              <use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#chat"></use>
            </svg>
          </span>
          <p>This is the start of your first session with
            <b>{{session.recipientName}}</b>. Please <b>type and send</b> a message above to begin.</p>
        </div>
      </li>

      <li *ngFor="let message of sessionMessages" [ngClass]="{'slds-chat-listitem':true, 'slds-chat-listitem_inbound':!message.mine, 'slds-chat-listitem_outbound':message.mine}">
        <div class="slds-chat-message">
          <div class="slds-chat-message__body">
            <div [ngSwitch]="message.sessionMessageTypeId" [ngClass]="{'slds-chat-message__text':true, 'slds-chat-message__text_inbound':!message.mine, 'slds-chat-message__text_outbound':message.mine}">
              <div *ngSwitchCase="1">
                {{message.text}}
                <div *ngIf="message.loading" class="slds-align_absolute-center slds-m-top_medium">
                  <div role="status" class="slds-spinner slds-spinner_x-small slds-spinner_inline">
                    <span class="slds-assistive-text">Loading</span>
                    <div class="slds-spinner__dot-a"></div>
                    <div class="slds-spinner__dot-b"></div>
                  </div>
                </div>
              </div>

              <div *ngSwitchCase="2" style="width: 13rem;">
                <div class="slds-file slds-file_card slds-file_loading slds-has-title">
                  <figure>
                    <a [href]="message.sessionMessageAttachment.url" target="_blank" class="slds-file__crop">
                      <div *ngIf="!message.sessionMessageAttachment.url" role="status" class="slds-spinner slds-spinner_medium" style="top:35%">
                        <span class="slds-assistive-text">Loading</span>
                        <div class="slds-spinner__dot-a"></div>
                        <div class="slds-spinner__dot-b"></div>
                      </div>

                      <div *ngIf="attachmentIsImage(message.sessionMessageAttachment) && message.sessionMessageAttachment.url">
                        <img [src]="message.sessionMessageAttachment.url" />
                      </div>

                      <span *ngIf="!attachmentIsImage(message.sessionMessageAttachment) && message.sessionMessageAttachment.url" class="slds-file__icon slds-icon_container" title="image">
                        <svg class="slds-icon" aria-hidden="true">
                          <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/assets/icons/doctype-sprite/svg/symbols.svg#image" />
                        </svg>
                        <span class="slds-assistive-text">Image Title</span>
                      </span>

                      <figcaption class="slds-file__title slds-file__title_card">
                        <div class="slds-media slds-media_small slds-media_center slds-truncate">
                          <div class="slds-media__figure slds-line-height_reset">
                            <span class="slds-icon_container" title="image">
                              <svg class="slds-icon slds-icon_x-small" aria-hidden="true">
                                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/assets/icons/doctype-sprite/svg/symbols.svg#image" />
                              </svg>
                              <span class="slds-assistive-text">image</span>
                            </span>
                          </div>
                          <div class="slds-media__body slds-truncate">
                            <span class="slds-file__text" style="color: black" title="Image Title">{{message.sessionMessageAttachment.fileName}}</span>
                          </div>
                        </div>
                      </figcaption>
                    </a>
                  </figure>
                </div>
              </div>
            </div>
            <div [ngSwitch]="message.mine">
              <div class="slds-chat-message__meta">
                <span *ngSwitchCase="true">You • {{helpersService.convertToLocalDate(message.createDate) | timeAgo}}</span>
                <span *ngSwitchCase="false">{{message.senderName}} •
                  {{helpersService.convertToLocalDate(message.createDate) | timeAgo}}</span>
              </div>
            </div>
          </div>
        </div>
      </li>

    </ul>
  </section>

  <div *ngIf="loading" class="slds-align_absolute-center slds-m-top_x-large">
    <div role="status" class="slds-spinner slds-spinner_medium slds-spinner_inline">
      <span class="slds-assistive-text">Loading</span>
      <div class="slds-spinner__dot-a"></div>
      <div class="slds-spinner__dot-b"></div>
    </div>
  </div>

  <div *ngIf="!loading" class="slds-align_absolute-center slds-m-vertical_small">
    <a *ngIf="!noMoreToLoad && initialGetMaxedOut" class="slds-button" (click)="loadPreviousMessages()">Load more</a>
    <span *ngIf="noMoreToLoad && initialGetMaxedOut">No more messages found</span>
  </div>
</div>

<div [hidden]="!showAttachments">
  <app-session-attachments #attachmentsCmp [sessionId]="attachmentsSessionId" (onFileUpload)="handleFileUpload($event)" (onClose)="handleAttachmentsClose()"></app-session-attachments>
</div>